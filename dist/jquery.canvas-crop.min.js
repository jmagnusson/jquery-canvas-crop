/*! jquery.canvas-crop %> */
!function(a){"use strict";"function"==typeof define&&define.amd?define(["jquery"],a):a(window.jQuery)}(function(a){"use strict";var b,c,d,e,f=function(a){return"number"==typeof a};b=function(c,f){var g=window.getComputedStyle(c,null),h=function(a){return parseInt(g.getPropertyValue(a),10)};this.$canvas=a(c),this.$window=a(window),this.options=a.extend({},b.DEFAULTS,f),this.context=c.getContext("2d"),this.image=null,this.marquee="ellipse"===this.options.marqueeType?new e:new d,this.state={canvas:{paddingLeft:h("padding-left"),paddingTop:h("padding-top"),borderTop:h("border-top-width"),borderLeft:h("border-left-width")},repositioning:!1,repositioningCoords:{x:null,y:null},repositioningOffset:{x:null,y:null},resizing:!1,resizingCoords:{x:null,y:null},shiftKey:!1},this.init()},b.DEFAULTS={marqueeType:"rectangle",aspectRatio:null,src:"",enableRawDataOutput:!1},b.prototype.init=function(){var b=this;this.$canvas.on("mousedown",a.proxy(this.handleMousedown,this)).on("mousemove",a.proxy(this.handleMousemove,this)).on("crop.api.selectall",a.proxy(this.selectAll,this)).on("crop.api.deselect",a.proxy(this.drawBackground,this)).css("cursor","crosshair"),this.$window.on("mouseup",a.proxy(this.handleMouseup,this)).on("keyup keydown",function(a){return b.state.shiftKey=a.shiftKey,!0}),this.drawBackground()},b.prototype.handleMousedown=function(a){var b=this.getMouse(a),c=this.state,d=this.marquee;d&&d.contains(b.x,b.y)?(c.repositioning=!0,c.resizing=!1,c.repositioningOffset.x=b.x-d.x,c.repositioningOffset.y=b.y-d.y):(c.repositioning=!1,c.resizing=!0)},b.prototype.handleMouseup=function(){(this.state.repositioning||this.state.resizing)&&this.finishResize(),this.state.repositioning=!1,this.state.resizing=!1},b.prototype.handleMousemove=function(a){var b=this.state,c=this.getMouse(a),d=this.marquee;return d&&(d.contains(c.x,c.y)?this.$canvas.css("cursor","move"):this.$canvas.css("cursor","crosshair")),b.repositioning||b.resizing?(this.clearCanvas(),void(b.repositioning?this.repositionMarquee(a):b.resizing&&this.resizeMarquee(a))):(b.resizingCoords.x=null,void(b.resizingCoords.y=null))},b.prototype.repositionMarquee=function(b){var c,d,e=this.getMouse(b),f=this.state,g=this.getScaledDimensions(),h=this.marquee;c=e.x-f.repositioningOffset.x,d=e.y-f.repositioningOffset.y,c=Math.min(Math.max(c,g.x),g.x2-h.w),d=Math.min(Math.max(d,g.y),g.y2-h.h),this.draw(c,d,h.w,h.h),this.$canvas.trigger(a.Event("crop.reposition",{coordinates:this.getCropCoordinates(!0)}))},b.prototype.resizeMarquee=function(b){var c,d,e,f,g,h=this.getMouse(b),i=this.state,j=this.getScaledDimensions(),k=this.options.aspectRatio;i.resizingCoords.x&&i.resizingCoords.y||(i.resizingCoords=h,i.repositioningCoords=h),c=Math.min(Math.max(i.resizingCoords.x,j.x),j.x2),d=Math.min(Math.max(i.resizingCoords.y,j.y),j.y2),e=h.x<c?Math.max(h.x-c,j.x-c):Math.min(Math.max(h.x-c,0),j.x2-c),f=h.y<d?Math.max(h.y-d,j.y-d):Math.min(Math.max(h.y-d,0),j.y2-d),g=e/f,"number"==typeof k&&(e=e/g*k),e+i.resizingCoords.x>j.x2&&(e=j.x2-i.resizingCoords.x,f=e/k),e+i.resizingCoords.x<j.x&&(e=j.x-i.resizingCoords.x,f=e/k),this.draw(c,d,e,f),this.$canvas.trigger(a.Event("crop.resize",{coordinates:this.getCropCoordinates(!0)}))},b.prototype.draw=function(a,b,c,d){var e=this.context,f=this.getScaledDimensions();this.clearCanvas(),this.drawBackground(),e.fillStyle="rgba(0, 0, 0, .5)",e.fillRect(f.x,f.y,f.w,f.h),e.save(),this.marquee.update(a,b,c,d),this.marquee.draw(e),e.clip(),this.drawBackground(),e.restore()},b.prototype.selectAll=function(){var a=this.getScaledDimensions(),b=this.options.aspectRatio,c=a.w/a.h,d=[],e=0,f=0,g=a.w,h=a.h;"number"==typeof b&&(c>b?(g=a.w/c*b,e=(a.w-g)/2):(h=a.h/b*c,f=(a.h-h)/2)),d=[e+a.x,f+a.y,g,h],this.draw.apply(this,d),this.finishResize()},b.prototype.finishResize=function(){var b=this,c=this.getCropCoordinates(!0);[c.x,c.y,c.w,c.h].every(f)&&(this.$canvas.trigger(a.Event("crop.finish",{coordinates:c})),this.options.enableRawDataOutput&&this.getRawCroppedImageData(function(c){b.$canvas.trigger(a.Event("crop.data",{rawData:c}))}))},b.prototype.getCropCoordinates=function(a){var b,c,d=this.getScalingFactor(),e=this.marquee;if(!e)return null;if(b=this.getScaledDimensions(),c={x:(e.x-b.x)/d,y:(e.y-b.y)/d,w:e.w/d,h:e.h/d},a)for(var f in c)c.hasOwnProperty(f)&&(c[f]=Math.floor(c[f]));return c},b.prototype.drawBackground=function(){var a,b=this;if(a=function(){var a=b.getScaledDimensions();b.context.drawImage(b.image,a.x,a.y,a.w,a.h)},this.options.src&&!this.image){var c=this.options.src;if(this.image=document.createElement("img"),void 0!==this.options.crossOrigin&&(this.image.crossOrigin=this.options.crossOrigin),c instanceof window.File){if(!window.URL||!window.URL.createObjectURL)return void console.error("Can't handle file objects as the browser is missing support for URL.createObjectUrl.");c=window.URL.createObjectURL(c)}this.image.src=c,this.image.onload=a}else a()},b.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.getCanvasWidth(),this.getCanvasHeight()),this.$canvas.trigger(a.Event("crop.cleared"))},b.prototype.getScaledDimensions=function(){var a=this.getScalingFactor(),b=this.image.width*a,c=this.image.height*a,d=(this.getCanvasWidth()-b)/2,e=(this.getCanvasHeight()-c)/2;return{x:d,y:e,x2:d+b,y2:e+c,w:b,h:c}},b.prototype.getScalingFactor=function(){var a=this.getCanvasWidth()/this.image.width,b=this.getCanvasHeight()/this.image.height;return Math.min(Math.min(a,b),1)},b.prototype.getCanvasWidth=function(){return this.$canvas[0].width},b.prototype.getCanvasHeight=function(){return this.$canvas[0].height},b.prototype.getMouse=function(b){var c=b.target,d=a(c).offset();return{x:b.pageX-d.left-this.state.canvas.paddingLeft-this.state.canvas.borderLeft,y:b.pageY-d.top-this.state.canvas.paddingTop-this.state.canvas.borderTop}},b.prototype.getRawCroppedImageData=function(a){var b,c=document.createElement("canvas"),d=c.getContext("2d"),e=this.getCropCoordinates(!0);if(b={x:e.x,y:e.y,w:e.w,h:e.h,image:{w:this.image.width,h:this.image.height}},c.width=e.w,c.height=e.h,d.drawImage(this.image,e.x,e.y,e.w,e.h,0,0,e.w,e.h),c.toBlob&&window.URL.createObjectURL)c.toBlob(function(c){b.data=window.URL.createObjectURL(c),a(b)},"image/png");else{try{b.data=c.toDataURL("image/png")}catch(f){b.data=null,b.exception=f}a(b)}},c=function(){},c.prototype.constructor=c,Object.defineProperty(c,"strokeStyle",{value:"rgba(255, 255, 255, 0.5)"}),c.prototype.normalize=function(){this.x=this.w<0?this.x+this.w:this.x,this.y=this.h<0?this.y+this.h:this.y,this.w=Math.abs(this.w),this.h=Math.abs(this.h)},c.prototype.draw=function(){throw'Method "draw" must be implemented on objects inheriting from Shape.'},c.prototype.contains=function(){throw'Method "contains" must be implemented on objects inheriting from Shape.'},d=function(){this.update.apply(this,arguments)},d.prototype=Object.create(c.prototype),d.prototype.update=function(a,b,c,d){this.x=a,this.y=b,this.w=c,this.h=d,this.normalize()},d.prototype.draw=function(a){a.beginPath(),a.rect(this.x,this.y,this.w,this.h),a.strokeStyle=c.strokeStyle,a.strokeRect(this.x,this.y,this.w,this.h)},d.prototype.contains=function(a,b){return this.x<=a&&this.x+this.w>=a&&this.y<=b&&this.y+this.h>=b},e=function(){this.update.apply(this,arguments)},e.prototype=Object.create(c.prototype),e.prototype.update=function(a,b,c,d){this.kappa=.5522848,this.x=a,this.y=b,this.w=c,this.h=d,this.ox=c/2*this.kappa,this.oy=d/2*this.kappa,this.xe=a+c,this.ye=b+d,this.xm=a+c/2,this.ym=b+d/2,this.xr=c/2,this.yr=d/2},e.prototype.contains=function(a,b){return Math.pow(a-this.xm,2)/Math.pow(this.xr,2)+Math.pow(b-this.ym,2)/Math.pow(this.yr,2)<=1},e.prototype.draw=function(a){var b=this.x,d=this.y,e=this.ox,f=this.oy,g=this.xe,h=this.ye,i=this.xm,j=this.ym;a.beginPath(),a.moveTo(b,j),a.bezierCurveTo(b,j-f,i-e,d,i,d),a.bezierCurveTo(i+e,d,g,j-f,g,j),a.bezierCurveTo(g,j+f,i+e,h,i,h),a.bezierCurveTo(i-e,h,b,j+f,b,j),a.strokeStyle=c.strokeStyle,a.stroke()},a.fn.canvasCrop=function(c){return this.each(function(){var d=a(this),e=d.data("canvas-crop"),f=a.extend({},b.DEFAULTS,d.data(),"object"==typeof c&&c);e||d.data("canvas-crop",e=new b(this,f))})},a.fn.canvasCrop.Constructor=b});